@{
    ViewData["Title"] = "Changer Formation";
}
<div class="container">
    <h2>Changer la formation</h2>

    <div class="form-row mb-3">
        <label for="formationSelect">Formation :</label>
        <select id="formationSelect" class="form-control" style="max-width:200px;">
            <option>4-4-2</option>
            <option>4-3-3</option>
            <option>4-2-3-1</option>
            <option>3-5-2</option>
            <option>3-4-3</option>
            <option>5-3-2</option>
            <option>4-5-1</option>
        </select>
        <button id="btnGenerer" class="btn btn-primary mt-2">Générer</button>
    </div>

    <div id="pitch" style="position:relative; width:100%; max-width:600px; height:400px; background:#3a8f3a; border:2px solid #2e6b2e; margin-bottom:1rem;">
        <!-- postes seront injectés ici -->
    </div>

    <div id="info" style="max-width:600px;"></div>
</div>

    <script>
        async function postFormation(formation) {
            // Récupérer le token anti-forgery si présent
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            const headers = { 'Content-Type': 'application/json' };
            if (tokenElement) headers['RequestVerificationToken'] = tokenElement.value;

            const res = await fetch('/Compositions/GenererNouvelleFormation', {
                method: 'POST',
                headers,
                body: JSON.stringify({ nouvelleFormation: formation })
            });
            if (!res.ok) throw new Error('Erreur réseau');
            return res.json();
        }

        function renderPostes(postes) {
            const pitch = document.getElementById('pitch');
            pitch.innerHTML = '';
            postes.forEach(p => {
                const el = document.createElement('div');
                el.className = 'poste';
                el.style.position = 'absolute';
                // PositionX et PositionY attendus en pourcentage (0..100)
                el.style.left = (p.positionX ?? p.PositionX ?? 50) + '%';
                el.style.top = (p.positionY ?? p.PositionY ?? 50) + '%';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.background = 'rgba(255,255,255,0.9)';
                el.style.border = '1px solid #333';
                el.style.padding = '4px 8px';
                el.style.borderRadius = '8px';
                el.style.cursor = 'default';
                el.innerText = p.nomPoste ?? p.NomPoste ?? 'Poste';
                pitch.appendChild(el);
            });
        }

        document.getElementById('btnGenerer').addEventListener('click', async () => {
            const formation = document.getElementById('formationSelect').value;
            try {
                const data = await postFormation(formation);
                if (data.success) {
                    renderPostes(data.postes);
                    document.getElementById('info').innerText = 'Formation générée : ' + (data.formation || formation);
                } else {
                    document.getElementById('info').innerText = 'Erreur lors de la génération';
                }
            } catch (ex) {
                document.getElementById('info').innerText = 'Erreur: ' + ex.message;
            }
        });

        // Générer par défaut à l'ouverture
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnGenerer').click();
        });
    </script>
